#!/bin/sh

set -e
unset GIT_DIR     # Avoid GIT_DIR leak from previous build steps
set -o errexit    # always exit on error
set -o nounset    # fail on unset variables


indent() {
  sed -u 's/^/       /'
}

echo "-----> Found add-on vco-backup"




#get file name from vco-backup
FILE_NAME="`cat $1/vco-backup`"

#compress actual code
#tar -cvzf /tmp/${FILE_NAME}.tgz $1

#mv /tmp/${FILE_NAME}.tgz $1




BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}
BP_DIR=$(cd $(dirname ${0:-}); cd ..; pwd)
LOG_FILE='/tmp/node-build-log.txt'

echo "Build dir: ${BUILD_DIR}"
echo "Cache dir: ${CACHE_DIR}"
echo "Env dir: ${ENV_DIR}"
echo "BP dir: ${BP_DIR}"

### Load dependencies
source ${BP_DIR}/lib/output.sh

### Upload with Node
npm install | output "$LOG_FILE"


BUILD_DIR=${BUILD_DIR} \
CACHE_DIR=${CACHE_DIR} \
ENV_DIR=${ENV_DIR} \
SOURCE_VERSION=${SOURCE_VERSION} \
node ${BP_DIR}/lib/upload.js | output "$LOG_FILE"








